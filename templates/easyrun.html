<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Run - C++ Online Editor</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: Consolas, "Courier New", monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 全局工具栏 */
        #global-toolbar {
            height: 45px;
            min-height: 45px;
            background-color: #252526;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            z-index: 50;
            padding: 0 5px;
        }
        .tool-group {
            display: flex;
            height: 100%;
            align-items: center;
        }
        .tool-btn {
            width: 50px;
            height: 100%;
            background-color: transparent;
            color: #ccc;
            border: none;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .tool-btn:active {
            background-color: #3e3e42;
        }
        #run-btn {
            color: #4ec9b0;
        }
        #copy-btn {
            color: #ce9178;
        }
        #mode-toggle-btn {
            background-color: #333;
            color: #fff;
            width: 60px;
            font-weight: bold;
        }

        /* 只读编辑器 */
        #editor-wrapper {
            display: flex;
            flex: 1;
            background-color: #111;
            overflow: auto;
            flex-direction: row;
        }

        /* 行号槽 */
        #gutter {
            width: 45px;
            min-width: 45px;
            height: 100%;
            background-color: #1e1e1e;
            color: #555;
            text-align: right;
            padding: 10px 5px 10px 0;
            border-right: 1px solid #333;
            overflow: hidden;
            user-select: none;
            z-index: 5;
            box-sizing: border-box;
            font-family: Consolas, "Courier New", monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 4;
        }

        #file-content {
            flex: 1;
            position: relative;
            height: 100%;
            overflow: auto;
        }

        #highlight-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 10px;
            margin: 0;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-break: break-all;
            color: #d4d4d4;
            pointer-events: none;
            z-index: 1;
            font-family: Consolas, "Courier New", monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 4;
        }

        /* 输入模态框 */
        #input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 300;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #252526;
            width: 85%;
            max-width: 400px;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-header {
            color: #ccc;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #modal-textarea {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 8px;
            font-family: Consolas, monospace;
            font-size: 14px;
            height: 150px;
            resize: none;
            outline: none;
            user-select: text;
            -webkit-user-select: text;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 10px;
        }
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            color: #fff;
        }
        #modal-cancel {
            background-color: #3e3e42;
        }
        #modal-run {
            background-color: #0e639c;
        }

        /* 输出面板 */
        #output-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            min-height: 150px;
            background-color: #0d0d0d;
            border-top: 2px solid #007acc;
            z-index: 200;
            display: none;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            transition: height 0.1s ease; /* 平滑过渡效果 */
        }
        #output-header {
            height: 35px;
            background-color: #1e1e1e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #333;
            color: #eee;
            font-size: 14px;
            cursor: ns-resize; /* 上下调整大小光标 */
            user-select: none;
        }
        #output-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: Consolas, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            color: #ccc;
            user-select: text;
            -webkit-user-select: text;
            cursor: text; /* 文本选择光标 */
        }
        /* 关闭按钮使用默认光标 */
        #close-output {
            cursor: default;
        }
        /* 输出面板调整大小手柄 */
        #output-resizer {
            height: 6px;
            background: #007acc;
            cursor: ns-resize;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            border-bottom: 1px solid #333;
            z-index: 10;
        }
        .out-section {
            margin-bottom: 10px;
        }
        .out-title {
            color: #569cd6;
            font-weight: bold;
            margin-bottom: 4px;
            display: block;
        }
        .out-err {
            color: #f48771;
        }
        .out-warn {
            color: #cca700;
        }
        .out-res {
            color: #fff;
        }
        .out-stat {
            color: #6a9955;
            font-size: 12px;
            font-style: italic;
            border-top: 1px solid #333;
            margin-top: 5px;
            padding-top: 5px;
        }

        /* 高亮 */
        .hl-kw {
            color: #569cd6;
            font-weight: bold;
        }
        .hl-str {
            color: #ce9178;
        }
        .hl-com {
            color: #6a9955;
        }
        .hl-dir {
            color: #c586c0;
        }
        .hl-num {
            color: #b5cea8;
        }
    </style>
</head>
<body>
    <!-- 全局顶部栏 -->
    <div id="global-toolbar">
        <div class="tool-group">
            <button id="run-btn" class="tool-btn" title="运行">▶</button>
            <button id="copy-btn" class="tool-btn" title="复制">❐</button>
            <p style="color:#666; font-size:12px; margin-left:10px; line-height: 45px;">Powered by <a href="https://github.com/Huchangzhi/phoi">phoi</a></p>
        </div>
    </div>

    <!-- 输入模态框 -->
    <div id="input-modal">
        <div class="modal-content">
            <div class="modal-header">Standard Input (Stdin)</div>
            <textarea id="modal-textarea" placeholder="在此输入数据..."></textarea>
            <div class="modal-footer">
                <button id="modal-cancel" class="modal-btn">取消</button>
                <button id="modal-run" class="modal-btn">运行</button>
            </div>
        </div>
    </div>

    <!-- 输出面板 -->
    <div id="output-panel">
        <div id="output-header">
            <span>Terminal</span>
            <span id="close-output">✕</span>
        </div>
        <div id="output-content"></div>
        <div id="output-resizer" class="output-resizer"></div>
    </div>

    <!-- 只读编辑器 -->
    <div id="editor-wrapper">
        <!-- 左侧行号槽 -->
        <div id="gutter"></div>
        <!-- Monaco Editor 容器 -->
        <div id="editor-container" style="width:100%;height:100%;"></div>
    </div>


    <script src="https://unpkg.com/monaco-editor@0.33.0/min/vs/loader.js"></script>
    <script>
        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.33.0/min/vs' } });

        let monacoEditor = null;
        let isMonacoLoaded = false;

        function initMonacoEditor(code) {
            if (monacoEditor) {
                monacoEditor.dispose();
            }

            require(['vs/editor/editor.main'], function() {
                monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: code,
                    language: 'cpp',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    readOnly: true,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false
                });

                isMonacoLoaded = true;
            });
        }

        // DOM Elements
        const editorWrapper = document.getElementById('editor-wrapper');
        // Monaco Editor 初始化
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.33.0/min/vs' } });
        function initMonacoEditor(code) {
            if (monacoEditor) {
                monacoEditor.dispose();
            }

            require(['vs/editor/editor.main'], function () {
                monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: code,
                    language: 'cpp',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    readOnly: true,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false
                });
            });
        }

        const runBtn = document.getElementById('run-btn');
        const copyBtn = document.getElementById('copy-btn');
        const outputPanel = document.getElementById('output-panel');
        const outputContent = document.getElementById('output-content');
        const closeOutputBtn = document.getElementById('close-output');

        const inputModal = document.getElementById('input-modal');
        const modalTextarea = document.getElementById('modal-textarea');
        const modalRun = document.getElementById('modal-run');
        const modalCancel = document.getElementById('modal-cancel');

        // 从URL参数获取代码
        async function getCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlParam = urlParams.get('url');
            
            if (urlParam) {
                try {
                    // 如果是URL，则通过fetch获取内容
                    if (urlParam.startsWith('http://') || urlParam.startsWith('https://')) {
                        const response = await fetch(urlParam);
                        if (!response.ok) {
                            throw new Error(`HTTP Error: ${response.status}`);
                        }
                        return await response.text();
                    } else {
                        // 否则直接解码
                        return decodeURIComponent(urlParam);
                    }
                } catch (e) {
                    console.error('Failed to get code from URL:', e);
                    return `// Error loading code: ${e.message}`;
                }
            }
            return "// No code provided in URL parameter";
        }

        // 恢复保存的输入数据
        modalTextarea.value = localStorage.getItem('phoi_savedStdin') || "";
        modalTextarea.addEventListener('input', () => {
            localStorage.setItem('phoi_savedStdin', modalTextarea.value);
        });

        // Run & Copy
        runBtn.addEventListener('click', () => {
            inputModal.style.display = 'flex';
            modalTextarea.focus();
        });
        modalCancel.addEventListener('click', () => { inputModal.style.display = 'none'; });
        modalRun.addEventListener('click', () => {
            inputModal.style.display = 'none';
            executeRunCode(modalTextarea.value);
        });

        async function executeRunCode(stdin) {
            outputPanel.style.display = 'flex';
            outputContent.innerHTML = '<span style="color:#888;">Compiling and running...</span>';
            try {
                // 获取实际的代码内容
                const code = await getCodeFromUrl();
                
                // 构造API请求URL，传递实际的代码内容而不是URL
                const encodedCode = encodeURIComponent(code);
                const encodedStdin = encodeURIComponent(stdin);
                const apiUrl = `/easyrun_api?url=${encodedCode}&stdin=${encodedStdin}`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                let html = "";
                if(data.Warnings) html += `<div class="out-section"><span class="out-title out-warn">WARNINGS:</span><div class="out-warn">${escapeHtml(data.Warnings)}</div></div>`;
                if(data.Errors) html += `<div class="out-section"><span class="out-title out-err">ERRORS:</span><div class="out-err">${escapeHtml(data.Errors)}</div></div>`;
                if(data.Result) html += `<div class="out-section"><span class="out-title">OUTPUT:</span><div class="out-res">${escapeHtml(data.Result)}</div></div>`;
                else if(!data.Errors) html += `<div class="out-section"><span class="out-title">OUTPUT:</span><div class="out-res" style="color:#666">(No output)</div></div>`;
                if(data.Stats) html += `<div class="out-stat">${escapeHtml(data.Stats)}</div>`;
                outputContent.innerHTML = html;
            } catch (e) {
                outputContent.innerHTML = `<span class="out-err">Server Connection Error: ${e.message}<br>请确定网络状态良好并稍后再试</span>`;
            }
        }

        function copyCode() {
            const t = document.createElement('textarea');
            t.value = globalText;
            document.body.appendChild(t);
            t.select();
            try {
                if(document.execCommand('copy')){
                    if(navigator.vibrate) navigator.vibrate(50);
                } else {
                    alert('Copy failed');
                }
            } catch(e) {}
            document.body.removeChild(t);
        }
        copyBtn.addEventListener('click', copyCode);
        closeOutputBtn.addEventListener('click', () => outputPanel.style.display='none');

        // Core Helpers
        function escapeHtml(t) {
            return (t||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        }


        // 全局变量
        let globalText = '';

        // 更新行号并初始化 Monaco Editor
        function updateDisplay(code) {
            globalText = code;

            // 初始化 Monaco Editor
            initMonacoEditor(code);
        }


        // 页面加载完成后，获取代码并显示
        window.addEventListener('load', async () => {
            const code = await getCodeFromUrl();
            updateDisplay(code);

            // 如果URL参数中包含自动运行标志，则自动运行
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('autorun') && urlParams.get('autorun') === 'true') {
                setTimeout(() => {
                    runBtn.click();
                }, 500); // 延迟执行，确保页面完全加载
            }
        });

        // 添加输出面板调整大小功能
        let isResizing = false;
        const outputPanel = document.getElementById('output-panel');
        const outputResizer = document.getElementById('output-resizer');
        const globalToolbar = document.getElementById('global-toolbar');

        // 鼠标按下调整大小手柄时
        outputResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'ns-resize';
            e.preventDefault();
        });

        // 鼠标移动时调整输出面板大小
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            // 计算新的高度（基于窗口高度和鼠标位置）
            const windowHeight = window.innerHeight;
            const newY = e.clientY;
            const newHeight = windowHeight - newY;

            // 设置最小和最大高度限制
            const minHeight = 150; // 最小高度
            const maxHeight = windowHeight - globalToolbar.offsetHeight - 100; // 最大高度

            // 应用边界限制
            const clampedHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));

            outputPanel.style.height = `${clampedHeight}px`;
        });

        // 鼠标释放时结束调整大小
        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = '';
        });

    </script>
</body>
</html>