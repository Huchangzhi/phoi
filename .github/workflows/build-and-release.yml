name: Build and Release PH Code

on:
  push:
    tags:
      - 'v*'  # 以v开头的标签触发构建

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install pyinstaller flask requests

    - name: Download and setup MinGW
      run: |
        # 下载MinGW-w64
        Invoke-WebRequest -Uri "https://github.com/brechtsanders/winlibs_x64/releases/download/12.2.0-15.0.6-11.0.1-ucrt-r1/winlibs-x86_64-posix-seh-gcc-12.2.0-mingw-w64msvcrt-11.0.1-r1.7z" -OutFile "mingw.7z"
        7z x mingw.7z -oC:\mingw
        echo "C:\mingw\mingw64\bin" >> $env:GITHUB_PATH

    - name: Build executable with PyInstaller
      run: |
        python -c "
        import PyInstaller.__main__
        import os
        spec_content = '''
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['app_gui.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('templates', 'templates'),
        ('static', 'static'),
    ],
    hiddenimports=['tkinter', 'subprocess', 'socket', 'urllib.parse', 're', 'tempfile', 'shutil', 'time'],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='PH_Code_Server',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=True,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='logo.png' if os.path.exists('logo.png') else None,
)
'''
        with open('ph_code.spec', 'w') as f:
            f.write(spec_content)
        "
        pyinstaller ph_code.spec --clean --noconfirm

    - name: Copy MinGW files
      run: |
        mkdir dist/PH_Code_Server/mingw/bin
        copy C:\mingw\mingw64\bin\g++.exe dist/PH_Code_Server/mingw/bin\
        copy C:\mingw\mingw64\bin\gcc.exe dist/PH_Code_Server/mingw/bin\
        copy C:\mingw\mingw64\bin\ld.exe dist/PH_Code_Server/mingw/bin\
        copy C:\mingw\mingw64\bin\libgcc_s_seh-1.dll dist/PH_Code_Server/mingw/bin\
        copy C:\mingw\mingw64\bin\libstdc++-6.dll dist/PH_Code_Server/mingw/bin\
        copy C:\mingw\mingw64\bin\libwinpthread-1.dll dist/PH_Code_Server/mingw/bin\

    - name: Create version info
      run: |
        $version = $env:GITHUB_REF.Substring($env:GITHUB_REF.LastIndexOf('/') + 1)
        $info = @{
          version = $version
          build_date = (Get-Date).ToString()
          includes_mingw = $true
          platform = "windows"
        } | ConvertTo-Json
        $info | Out-File -FilePath dist/PH_Code_Server/version.json -Encoding utf8

    - name: Create ZIP archive
      run: |
        $version = $env:GITHUB_REF.Substring($env:GITHUB_REF.LastIndexOf('/') + 1)
        Compress-Archive -Path dist/PH_Code_Server/* -DestinationPath "PH_Code_Server_$version.zip"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: PH Code Server ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./PH_Code_Server_${{ github.ref_name }}.zip
        asset_name: PH_Code_Server_${{ github.ref_name }}.zip
        asset_content_type: application/zip