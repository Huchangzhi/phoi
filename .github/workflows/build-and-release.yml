name: Build and Release PH Code

on:
  push:
    tags:
      - 'v*'  # 以v开头的标签触发构建
  workflow_dispatch:  # 允许手动触发
    inputs:
      build_only:
        description: '仅构建，不发布'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install pyinstaller flask requests

    - name: Download and setup MinGW
      run: |
        # 下载MinGW-w64
        $url = "https://github.com/brechtsanders/winlibs_x64/releases/download/12.2.0-15.0.6-11.0.1-ucrt-r1/winlibs-x86_64-posix-seh-gcc-12.2.0-mingw-w64msvcrt-11.0.1-r1.7z"
        $output = "mingw.7z"
        Invoke-WebRequest -Uri $url -OutFile $output
        7z x $output -oC:\mingw
        echo "C:\mingw\mingw64\bin" >> $env:GITHUB_PATH

    - name: Create spec file
      run: |
        echo "# -*- mode: python ; coding: utf-8 -*-" > ph_code.spec
        echo "" >> ph_code.spec
        echo "block_cipher = None" >> ph_code.spec
        echo "" >> ph_code.spec
        echo "a = Analysis([" >> ph_code.spec
        echo "    ['app_gui.py']," >> ph_code.spec
        echo "    pathex=[]," >> ph_code.spec
        echo "    binaries=[]," >> ph_code.spec
        echo "    datas=[" >> ph_code.spec
        echo "        ('templates', 'templates')," >> ph_code.spec
        echo "        ('static', 'static')," >> ph_code.spec
        echo "    ]," >> ph_code.spec
        echo "    hiddenimports=['tkinter', 'subprocess', 'socket', 'urllib.parse', 're', 'tempfile', 'shutil', 'time']," >> ph_code.spec
        echo "    hookspath=[]," >> ph_code.spec
        echo "    hooksconfig={}," >> ph_code.spec
        echo "    runtime_hooks=[]," >> ph_code.spec
        echo "    excludes=[]," >> ph_code.spec
        echo "    win_no_prefer_redirects=False," >> ph_code.spec
        echo "    win_private_assemblies=False," >> ph_code.spec
        echo "    cipher=block_cipher," >> ph_code.spec
        echo "    noarchive=False," >> ph_code.spec
        echo ")" >> ph_code.spec
        echo "" >> ph_code.spec
        echo "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)" >> ph_code.spec
        echo "" >> ph_code.spec
        echo "exe = EXE(" >> ph_code.spec
        echo "    pyz," >> ph_code.spec
        echo "    a.scripts," >> ph_code.spec
        echo "    a.binaries," >> ph_code.spec
        echo "    a.zipfiles," >> ph_code.spec
        echo "    a.datas," >> ph_code.spec
        echo "    []," >> ph_code.spec
        echo "    name='PH_Code_Server'," >> ph_code.spec
        echo "    debug=False," >> ph_code.spec
        echo "    bootloader_ignore_signals=False," >> ph_code.spec
        echo "    strip=False," >> ph_code.spec
        echo "    upx=True," >> ph_code.spec
        echo "    upx_exclude=[]," >> ph_code.spec
        echo "    runtime_tmpdir=None," >> ph_code.spec
        echo "    console=True," >> ph_code.spec
        echo "    disable_windowed_traceback=False," >> ph_code.spec
        echo "    argv_emulation=False," >> ph_code.spec
        echo "    target_arch=None," >> ph_code.spec
        echo "    codesign_identity=None," >> ph_code.spec
        echo "    entitlements_file=None," >> ph_code.spec
        echo "    icon='logo.png' if os.path.exists('logo.png') else None," >> ph_code.spec
        echo ")" >> ph_code.spec

    - name: Build executable with PyInstaller
      run: |
        pyinstaller ph_code.spec --clean --noconfirm

    - name: Copy MinGW files
      run: |
        New-Item -ItemType Directory -Force -Path "dist/PH_Code_Server/mingw/bin"
        Copy-Item "C:\mingw\mingw64\bin\g++.exe" -Destination "dist/PH_Code_Server/mingw/bin/"
        Copy-Item "C:\mingw\mingw64\bin\gcc.exe" -Destination "dist/PH_Code_Server/mingw/bin/"
        Copy-Item "C:\mingw\mingw64\bin\ld.exe" -Destination "dist/PH_Code_Server/mingw/bin/"
        Copy-Item "C:\mingw\mingw64\bin\libgcc_s_seh-1.dll" -Destination "dist/PH_Code_Server/mingw/bin/"
        Copy-Item "C:\mingw\mingw64\bin\libstdc++-6.dll" -Destination "dist/PH_Code_Server/mingw/bin/"
        Copy-Item "C:\mingw\mingw64\bin\libwinpthread-1.dll" -Destination "dist/PH_Code_Server/mingw/bin/"

    - name: Create version info
      run: |
        # 使用不同的方式确定版本号，以支持手动运行
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "manual_build_" + (Get-Date -Format "yyyyMMdd_HHmmss")
        } else {
          $version = "${{ github.ref_name }}"
        }
        $info = @{
          version = $version
          build_date = (Get-Date).ToString()
          includes_mingw = $true
          platform = "windows"
          trigger = "${{ github.event_name }}"
        } | ConvertTo-Json
        $info | Out-File -FilePath dist/PH_Code_Server/version.json -Encoding utf8

    - name: Create ZIP archive
      run: |
        # 确定版本号
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "manual_build_" + (Get-Date -Format "yyyyMMdd_HHmmss")
        } else {
          $version = "${{ github.ref_name }}"
        }
        Compress-Archive -Path dist/PH_Code_Server/* -DestinationPath "PH_Code_Server_$version.zip"

    # 条件性发布：仅在推送标签时发布，而不是手动运行时
    - name: Create Release
      if: github.event_name == 'push'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: PH Code Server ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      if: github.event_name == 'push'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./PH_Code_Server_${{ github.ref_name }}.zip
        asset_name: PH_Code_Server_${{ github.ref_name }}.zip
        asset_content_type: application/zip